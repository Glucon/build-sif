# ---------- Stage 1: build ----------
Bootstrap: docker-archive
From: ./debian13.0.tar
Stage: build

%labels
    Maintainer yangys
    Build Wannier90 (v3.1.0) in debian 13.0

%files
    ./wannier90-3.1.0.tar.gz /opt

%post -c /bin/bash
    sed -i 's|deb.debian.org|mirrors.ustc.edu.cn|g' /etc/apt/sources.list.d/debian.sources
    sed -i 's|security.debian.org/debian-security|mirrors.ustc.edu.cn/debian-security|g' /etc/apt/sources.list.d/debian.sources

    apt-get update && apt-get install -y --no-install-recommends \
        build-essential \
        gfortran \
        libopenmpi-dev \
        libopenblas-dev

    tar -xf /opt/wannier90-3.1.0.tar.gz -C /opt
    cp /opt/wannier90-3.1.0/config/make.inc.gfort /opt/wannier90-3.1.0/make.inc
    sed -i \
      -e 's/^F90 = .*/F90 = mpif90\nCOMMS  = mpi\nMPIF90 = mpif90/' \
      -e 's/^LIBS = .*/LIBS = -lopenblas/' \
      -e 's/^FCOPTS = -O3$/FCOPTS = -O3 -fallow-argument-mismatch/' \
      /opt/wannier90-3.1.0/make.inc
    cd /opt/wannier90-3.1.0 && make default -j$(nproc)

# ---------- Stage 2: final runtime image ----------
Bootstrap: docker-archive
From: ./debian13.0.tar
Stage: runtime

%labels
    Maintainer yangys
    Runtime Wannier90 (v3.1.0) in debian 13.0

%files from build
    /opt/wannier90-3.1.0/wannier90.x /usr/local/bin
    /opt/wannier90-3.1.0/postw90.x /usr/local/bin

%post -c /bin/bash
    sed -i 's|deb.debian.org|mirrors.ustc.edu.cn|g' /etc/apt/sources.list.d/debian.sources
    sed -i 's|security.debian.org/debian-security|mirrors.ustc.edu.cn/debian-security|g' /etc/apt/sources.list.d/debian.sources

    apt-get update && apt-get install -y --no-install-recommends \
        libopenblas0 \
        libopenmpi40 \
        openmpi-bin

    apt-get autoremove -y
    apt-get clean
    rm -rf /var/lib/apt/lists/* /root/.cache

%environment
    export OMPI_ALLOW_RUN_AS_ROOT=1
    export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
    : "${OMP_NUM_THREADS:=1}"

%runscript
    #/bin/bash
    exec wannier90.x "$@"
